<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F1 Pit Stops - Official Style</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Titillium+Web:wght@400;600;700;900&display=swap');
        
        body {
            background: #000;
            font-family: 'Titillium Web', sans-serif;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        
        .f1-header {
            background: linear-gradient(90deg, #000 0%, #1a1a1a 100%);
            border-bottom: 3px solid #e10600;
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .pirelli-badge {
            background: #ffd700;
            color: #000;
            font-weight: 900;
            padding: 8px 20px;
            border-radius: 4px;
            letter-spacing: 3px;
            font-size: 18px;
        }
        
        .driver-row {
            display: flex;
            align-items: center;
            padding: 8px 40px;
            border-bottom: 1px solid #222;
            transition: all 0.3s;
            animation: slideIn 0.5s ease forwards;
        }
        
        .driver-row:hover {
            background: #0a0a0a;
        }
        
        .driver-name {
            width: 200px;
            color: #fff;
            font-weight: 700;
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .stint-bar {
            flex: 1;
            height: 28px;
            position: relative;
            background: #0a0a0a;
            border: 1px solid #333;
            display: flex;
        }
        
        .stint-segment {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 13px;
            position: relative;
            border-right: 2px solid #000;
        }
        
        .stint-segment.used::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 3px,
                rgba(0,0,0,0.2) 3px,
                rgba(0,0,0,0.2) 6px
            );
        }
        
        .lap-count {
            width: 60px;
            text-align: center;
            color: #fff;
            font-weight: 700;
            font-size: 18px;
            margin-left: 15px;
        }
        
        .tyre-legend {
            display: flex;
            gap: 30px;
            align-items: center;
            padding: 30px 40px;
            background: #0a0a0a;
        }
        
        .tyre-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .tyre-circle {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            border: 3px solid #333;
            position: relative;
        }
        
        .tyre-circle::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 18px;
            height: 18px;
            background: #fff;
            border-radius: 50%;
        }
        
        .tyre-label {
            color: #fff;
            font-weight: 700;
            font-size: 14px;
            text-transform: uppercase;
        }
        
        .total-pitstops {
            position: absolute;
            top: 80px;
            right: 40px;
            text-align: right;
        }
        
        .total-pitstops-label {
            color: #999;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        .total-pitstops-value {
            color: #e10600;
            font-size: 72px;
            font-weight: 900;
            line-height: 1;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7/babel.min.js"></script>

    {% raw %}
    <script type="text/babel">
        const { useState, useEffect } = React;

        const PitStopsChart = () => {
            const [driversData, setDriversData] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [totalPitStops, setTotalPitStops] = useState(0);
            const [sessaoInfo, setSessaoInfo] = useState({ nome_pista: '', total_voltas: 0 });

            useEffect(() => {
                fetchData();
            }, []);

            const fetchData = async () => {
                try {
                    // Pega sessao_id da URL ou usa a √∫ltima
                    const urlParams = new URLSearchParams(window.location.search);
                    const sessaoId = urlParams.get('sessao');
                    const url = sessaoId ? `/dados_stints/${sessaoId}` : '/dados_stints_ultimo';
                    
                    console.log("Fetching:", url);
                    const response = await fetch(url);
                    console.log("Response status:", response.status);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log("Dados recebidos:", data);
                    
                    if (data.sessao) {
                        setSessaoInfo(data.sessao);
                    }
                    
                    if (Array.isArray(data.pilotos)) {
                        processDriverData(data.pilotos, data.sessao?.total_voltas || 0);
                    }
                } catch (error) {
                    console.error('Erro:', error);
                    setDriversData([]);
                } finally {
                    setIsLoading(false);
                }
            };

            const processDriverData = (pilotos, totalVoltasSessao) => {
                const processed = pilotos.map((pilot) => {
                    const stints = pilot.stints || [];
                    const totalLaps = pilot.total_voltas || stints.reduce((sum, s) => sum + (s.total_voltas || 0), 0);

                    const pitStops = stints.length > 0 
                        ? stints.map((stint, idx) => ({
                            length: stint.total_voltas || (stint.volta_fim - stint.volta_inicio + 1),
                            compound: (stint.tipo_pneu || stint.composto || 'MEDIUM').toUpperCase().replace(' ', '_'),
                            isUsed: idx < stints.length - 1,
                            voltaInicio: stint.volta_inicio,
                            voltaFim: stint.volta_fim
                          }))
                        : [{
                            length: totalLaps,
                            compound: (pilot.pneu_atual || 'MEDIUM').toUpperCase(),
                            isUsed: false,
                            voltaInicio: 1,
                            voltaFim: totalLaps
                          }];

                    return {
                        name: pilot.nome,
                        number: pilot.numero,
                        position: pilot.posicao || 99,
                        pitStops: pitStops,
                        totalLaps: totalLaps
                    };
                }).sort((a, b) => a.position - b.position);

                const total = processed.reduce((sum, d) => sum + Math.max(0, d.pitStops.length - 1), 0);
                setTotalPitStops(total);
                setDriversData(processed);
            };

            const getTyreColor = (compound) => {
                const colors = {
                    'SOFT': '#ff1744',
                    'MEDIUM': '#ffd700',
                    'HARD': '#ffffff',
                    'INTERMEDIATE': '#4caf50',
                    'WET': '#2196f3',
                    'SUPER_SOFT': '#9306f1',
                    'C1': '#ffffff',
                    'C2': '#ffffff',
                    'C3': '#ffd700',
                    'C4': '#ff1744',
                    'C5': '#ff1744'
                };
                return colors[compound] || '#999';
            };

            if (isLoading) {
                return (
                    <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', minHeight: '100vh', color: 'white' }}>
                        <div style={{ textAlign: 'center' }}>
                            <div style={{ fontSize: '4rem', marginBottom: '1rem' }}>üèéÔ∏è</div>
                            <h2 style={{ fontSize: '2rem', fontWeight: 'bold' }}>Carregando...</h2>
                        </div>
                    </div>
                );
            }

            if (driversData.length === 0) {
                return (
                    <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', minHeight: '100vh', color: 'white' }}>
                        <div style={{ textAlign: 'center' }}>
                            <div style={{ fontSize: '4rem', marginBottom: '1rem' }}>‚ö†Ô∏è</div>
                            <h2 style={{ fontSize: '2rem', fontWeight: 'bold', marginBottom: '1rem' }}>Sem dados dispon√≠veis</h2>
                            <a href="/" style={{ display: 'inline-block', background: '#e10600', color: 'white', padding: '12px 24px', borderRadius: '4px', fontWeight: 'bold', textDecoration: 'none' }}>
                                üìä Ver Hist√≥rico
                            </a>
                        </div>
                    </div>
                );
            }

            const maxLaps = Math.max(...driversData.map(d => d.totalLaps), sessaoInfo.total_voltas || 1);

            return (
                <div style={{ background: '#000', minHeight: '100vh' }}>
                    {/* Header */}
                    <div className="f1-header">
                        <div style={{ display: 'flex', alignItems: 'center', gap: '20px' }}>
                            <span style={{ fontSize: '2rem' }}>üèéÔ∏è</span>
                            <div className="pirelli-badge">PIRELLI</div>
                        </div>
                        <div style={{ textAlign: 'right' }}>
                            <div style={{ color: '#999', fontSize: '14px', textTransform: 'uppercase', letterSpacing: '2px' }}>
                                {sessaoInfo.nome_pista || 'CIRCUIT'}
                            </div>
                            <div style={{ color: '#fff', fontSize: '36px', fontWeight: '900', letterSpacing: '3px' }}>
                                PIT STOPS
                            </div>
                        </div>
                    </div>

                    {/* Total Pit Stops */}
                    <div className="total-pitstops">
                        <div className="total-pitstops-label">Total Pit Stops</div>
                        <div className="total-pitstops-value">{totalPitStops}</div>
                    </div>

                    {/* Tyre Legend */}
                    <div className="tyre-legend">
                        <div className="tyre-item">
                            <div className="tyre-circle" style={{ background: getTyreColor('SOFT') }}></div>
                            <div className="tyre-label">Soft</div>
                        </div>
                        <div className="tyre-item">
                            <div className="tyre-circle" style={{ background: getTyreColor('MEDIUM') }}></div>
                            <div className="tyre-label">Medium</div>
                        </div>
                        <div className="tyre-item">
                            <div className="tyre-circle" style={{ background: getTyreColor('HARD') }}></div>
                            <div className="tyre-label">Hard</div>
                        </div>
                        <div className="tyre-item">
                            <div className="tyre-circle" style={{ background: getTyreColor('INTERMEDIATE') }}></div>
                            <div className="tyre-label">Inter</div>
                        </div>
                        <div className="tyre-item">
                            <div className="tyre-circle" style={{ background: getTyreColor('WET') }}></div>
                            <div className="tyre-label">Wet</div>
                        </div>
                        <div style={{ marginLeft: 'auto' }}>
                            <a href="/" style={{ color: '#e10600', fontWeight: 'bold', textDecoration: 'none' }}>
                                ‚Üê Voltar ao Hist√≥rico
                            </a>
                        </div>
                    </div>

                    {/* Drivers */}
                    <div style={{ marginTop: '40px' }}>
                        {driversData.map((driver, idx) => (
                            <div key={driver.name} className="driver-row" style={{ animationDelay: `${idx * 0.03}s` }}>
                                <div className="driver-name">
                                    <span style={{ color: '#e10600', marginRight: '10px' }}>P{driver.position}</span>
                                    {driver.name}
                                </div>
                                <div className="stint-bar">
                                    {driver.pitStops.map((stint, stintIdx) => {
                                        const widthPercent = (stint.length / maxLaps) * 100;
                                        const color = getTyreColor(stint.compound);
                                        const textColor = stint.compound === 'MEDIUM' || stint.compound === 'HARD' ? '#000' : '#fff';
                                        
                                        return (
                                            <div
                                                key={stintIdx}
                                                className={`stint-segment ${stint.isUsed ? 'used' : ''}`}
                                                style={{
                                                    width: `${widthPercent}%`,
                                                    background: color,
                                                    color: textColor
                                                }}
                                                title={`${stint.compound}: ${stint.length} voltas (${stint.voltaInicio}-${stint.voltaFim})`}
                                            >
                                                {stint.length > 4 && <span style={{ position: 'relative', zIndex: 1 }}>{stint.length}</span>}
                                            </div>
                                        );
                                    })}
                                </div>
                                <div className="lap-count">{driver.totalLaps}</div>
                            </div>
                        ))}
                    </div>

                    {/* Footer */}
                    <div style={{ padding: '40px', textAlign: 'center', color: '#666' }}>
                        {sessaoInfo.total_voltas > 0 && (
                            <span>Total da corrida: {sessaoInfo.total_voltas} voltas</span>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<PitStopsChart />);
    </script>
    {% endraw %}
</body>
</html>