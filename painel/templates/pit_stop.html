<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tyre Degradation Trend - F1 Style</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Titillium+Web:wght@400;600;700;900&display=swap');
        
        * {
            font-family: 'Titillium Web', sans-serif;
            box-sizing: border-box;
        }
        
        body {
            background: #e8e8e8;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .main-container {
            max-width: 1800px;
            margin: 0 auto;
        }
        
        .header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid #e10600;
        }
        
        .header h1 {
            font-size: 32px;
            font-weight: 900;
            color: #15151e;
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .header .flag { font-size: 28px; }
        
        .header .subtitle {
            font-size: 20px;
            color: #38383f;
            font-weight: 400;
            font-style: italic;
        }
        
        .controls {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
            background: #fff;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .controls select {
            padding: 10px 15px;
            font-size: 14px;
            border: 2px solid #ddd;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-weight: 600;
            min-width: 180px;
        }
        
        .controls select:focus {
            border-color: #e10600;
            outline: none;
        }
        
        .controls button {
            padding: 10px 20px;
            font-size: 14px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 700;
            text-transform: uppercase;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #e10600 0%, #ff1e1e 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(225, 6, 0, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #15151e 0%, #38383f 100%);
            color: white;
        }
        
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(21, 21, 30, 0.4);
        }
        
        .btn-outline {
            background: white;
            color: #15151e;
            border: 2px solid #15151e;
        }
        
        .btn-outline:hover {
            background: #15151e;
            color: white;
        }
        
        .btn-compare {
            background: linear-gradient(135deg, #6b21a8 0%, #9333ea 100%);
            color: white;
        }
        
        .btn-compare:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(147, 51, 234, 0.4);
        }
        
        /* Compara√ß√£o de Pilotos */
        .comparison-panel {
            background: linear-gradient(135deg, #1e1e2e 0%, #2d2d3d 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            color: white;
        }
        
        .comparison-panel h3 {
            margin: 0 0 15px 0;
            font-size: 18px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .driver-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .driver-chip {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .driver-chip.unselected {
            background: #3d3d4d;
            color: #aaa;
        }
        
        .driver-chip.selected {
            background: #e10600;
            color: white;
            border-color: #ff4444;
        }
        
        .driver-chip:hover {
            transform: scale(1.05);
        }
        
        .driver-chip .position {
            background: rgba(255,255,255,0.2);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
        }
        
        .comparison-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #444;
        }
        
        .stat-card {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        
        .stat-card .label {
            font-size: 11px;
            color: #aaa;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .stat-card .value {
            font-size: 24px;
            font-weight: 900;
            margin: 5px 0;
        }
        
        .stat-card .driver {
            font-size: 12px;
            color: #e10600;
        }
        
        .stat-card .value.green { color: #00d27f; }
        .stat-card .value.red { color: #e10600; }
        .stat-card .value.yellow { color: #FFC906; }
        
        .grid-container {
            display: grid;
            gap: 1px;
            background: #ccc;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .stint-label {
            background: linear-gradient(135deg, #4a6fa5 0%, #6b8cbe 100%);
            color: white;
            font-weight: 800;
            font-size: 18px;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-transform: uppercase;
            letter-spacing: 1px;
            min-height: 180px;
        }
        
        .driver-header {
            background: linear-gradient(180deg, #1e1e2e 0%, #2d2d3d 100%);
            color: white;
            text-align: center;
            padding: 12px 8px;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .driver-header .driver-name {
            font-weight: 700;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .driver-header .driver-position {
            font-size: 11px;
            color: #aaa;
            font-weight: 600;
        }
        
        .chart-cell {
            background: #fafafa;
            padding: 12px;
            position: relative;
            min-height: 180px;
            display: flex;
            flex-direction: column;
        }
        
        .chart-cell .stats {
            font-size: 11px;
            color: #15151e;
            line-height: 1.6;
            margin-bottom: 8px;
            z-index: 10;
        }
        
        .chart-cell .stats .avg { font-weight: 700; color: #15151e; }
        .chart-cell .stats .delta { font-weight: 600; }
        .chart-cell .stats .delta.positive { color: #e10600; }
        .chart-cell .stats .delta.negative { color: #00d27f; }
        .chart-cell .stats .delta.neutral { color: #666; }
        .chart-cell .stats .extra { font-size: 10px; color: #888; }
        
        .chart-cell canvas {
            flex: 1;
            width: 100% !important;
            height: auto !important;
            min-height: 100px;
        }
        
        .empty-cell {
            background: #f0f0f0;
            min-height: 180px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ccc;
            font-size: 20px;
        }
        
        .corner-cell { background: #e8e8e8; }
        
        .x-axis-label {
            text-align: center;
            padding: 15px;
            color: #38383f;
            font-weight: 700;
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 2px;
            background: white;
            margin-top: -1px;
            border-radius: 0 0 8px 8px;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            gap: 50px;
            margin-top: 25px;
            padding: 20px 30px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            flex-wrap: wrap;
        }
        
        .legend-section {
            display: flex;
            gap: 25px;
            align-items: center;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            font-weight: 600;
            color: #38383f;
        }
        
        .legend-line {
            width: 35px;
            height: 3px;
            border-radius: 2px;
        }
        
        .legend-line.solid { background: #15151e; }
        
        .tyre-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            display: inline-block;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        
        .tyre-supersoft { background: linear-gradient(135deg, #FF00FF 0%, #FF66FF 100%); }
        .tyre-soft { background: linear-gradient(135deg, #E10600 0%, #FF4444 100%); }
        .tyre-medium { background: linear-gradient(135deg, #FFC906 0%, #FFE066 100%); }
        .tyre-hard { background: linear-gradient(135deg, #EBEBEB 0%, #FFFFFF 100%); border: 2px solid #666; }
        .tyre-inter { background: linear-gradient(135deg, #43B02A 0%, #7ED957 100%); }
        .tyre-wet { background: linear-gradient(135deg, #0072C6 0%, #4AA8FF 100%); }
        
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #15151e 0%, #1e1e2e 50%, #e10600 100%);
        }
        
        .loading-content { text-align: center; color: white; }
        
        .loading-spinner {
            font-size: 5rem;
            animation: spin 1.5s linear infinite;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .no-data {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
            text-align: center;
            background: white;
            border-radius: 12px;
            padding: 60px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .no-data h2 { font-size: 28px; color: #15151e; margin-bottom: 15px; }
        .no-data p { color: #666; font-size: 16px; margin-bottom: 25px; }
        
        /* Modo Compara√ß√£o */
        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .comparison-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .comparison-card .card-header {
            background: linear-gradient(180deg, #1e1e2e 0%, #2d2d3d 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .comparison-card .card-header .driver-name {
            font-weight: 700;
            font-size: 18px;
            text-transform: uppercase;
        }
        
        .comparison-card .card-header .position {
            background: #e10600;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 700;
        }
        
        .comparison-card .card-body {
            padding: 20px;
        }
        
        .comparison-card .stint-row {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }
        
        .comparison-card .stint-row:last-child {
            border-bottom: none;
        }
        
        .comparison-card .stint-number {
            font-weight: 800;
            font-size: 14px;
            color: #4a6fa5;
            min-width: 60px;
        }
        
        .comparison-card .stint-info {
            flex: 1;
        }
        
        .comparison-card .stint-info .tyre-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .comparison-card .stint-stats {
            display: flex;
            gap: 20px;
            font-size: 12px;
        }
        
        .comparison-card .stint-stats span {
            color: #666;
        }
        
        .comparison-card .stint-stats strong {
            color: #15151e;
        }
        
        .vs-badge {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background: #e10600;
            color: white;
            font-weight: 900;
            font-size: 24px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(225, 6, 0, 0.4);
            z-index: 10;
        }
    </style>
</head>
<body>
    <div id="root">
        <div class="loading">
            <div class="loading-content">
                <div class="loading-spinner">üèéÔ∏è</div>
                <h2 style="font-size: 2rem; font-weight: bold; margin-top: 20px;">Carregando dados...</h2>
            </div>
        </div>
    </div>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7/babel.min.js"></script>

    {% raw %}
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const TyreDegradationChart = () => {
            const [data, setData] = useState({ pilotos: [], sessao: {} });
            const [isLoading, setIsLoading] = useState(true);
            const [selectedDrivers, setSelectedDrivers] = useState([]);
            const [maxStints, setMaxStints] = useState(3);
            const [viewMode, setViewMode] = useState('grid'); // 'grid' ou 'compare'
            const [compareDrivers, setCompareDrivers] = useState([]);

            useEffect(() => { fetchData(); }, []);

            const fetchData = async () => {
                try {
                    const urlParams = new URLSearchParams(window.location.search);
                    const sessaoId = urlParams.get('sessao');
                    
                    const stintsUrl = sessaoId ? `/dados_stints/${sessaoId}` : '/dados_stints_ultimo';
                    const voltasUrl = sessaoId ? `/dados_voltas/${sessaoId}` : '/dados_voltas';
                    
                    const [stintsResp, voltasResp] = await Promise.all([
                        fetch(stintsUrl),
                        fetch(voltasUrl)
                    ]);
                    
                    const stintsData = await stintsResp.json();
                    const voltasData = await voltasResp.json();
                    
                    console.log("Stints:", stintsData);
                    console.log("Voltas:", voltasData);
                    
                    const pilotos = processData(stintsData, voltasData);
                    
                    setData({
                        pilotos: pilotos,
                        sessao: stintsData.sessao || voltasData.sessao || {}
                    });
                    
                    // Ordena por posi√ß√£o e seleciona top 8
                    const sortedPilotos = [...pilotos].sort((a, b) => (a.posicao || 99) - (b.posicao || 99));
                    const top8 = sortedPilotos.slice(0, 8).map(p => p.nome);
                    setSelectedDrivers(top8);
                    
                    const max = Math.max(...pilotos.map(p => p.stints?.length || 0), 1);
                    setMaxStints(Math.min(max, 5));
                    
                } catch (error) {
                    console.error('Erro:', error);
                } finally {
                    setIsLoading(false);
                }
            };

            const processData = (stintsData, voltasData) => {
                const pilotosStints = stintsData.pilotos || [];
                const pilotosVoltas = voltasData.pilotos || voltasData || [];
                
                const voltasPorPiloto = {};
                (Array.isArray(pilotosVoltas) ? pilotosVoltas : []).forEach(p => {
                    voltasPorPiloto[p.nome] = p.voltas || [];
                });
                
                return pilotosStints.map(piloto => {
                    const voltas = voltasPorPiloto[piloto.nome] || [];
                    const stints = piloto.stints || [];
                    
                    const stintsComTempos = stints.map((stint) => {
                        const voltasDoStint = voltas.filter(v => {
                            const numVolta = v.numero_volta;
                            return numVolta >= stint.volta_inicio && numVolta <= stint.volta_fim;
                        });
                        
                        // Filtra tempos v√°lidos
                        let tempos = voltasDoStint
                            .map(v => v.tempo_total)
                            .filter(t => t > 30 && t < 300);
                        
                        // üÜï C√ÅLCULO MAIS PRECISO: Remove outliers (IQR)
                        tempos = removeOutliers(tempos);
                        
                        const avgTime = tempos.length > 0 
                            ? tempos.reduce((a, b) => a + b, 0) / tempos.length 
                            : 0;
                        
                        const bestTime = tempos.length > 0 ? Math.min(...tempos) : 0;
                        const worstTime = tempos.length > 0 ? Math.max(...tempos) : 0;
                        
                        // üÜï REGRESS√ÉO LINEAR MELHORADA
                        let deltaPerLap = 0;
                        let rSquared = 0; // Qualidade do ajuste
                        
                        if (tempos.length >= 3) {
                            const regression = linearRegression(tempos);
                            deltaPerLap = regression.slope;
                            rSquared = regression.rSquared;
                        }
                        
                        // Desvio padr√£o (consist√™ncia)
                        const stdDev = tempos.length > 0 
                            ? Math.sqrt(tempos.reduce((sum, t) => sum + (t - avgTime) ** 2, 0) / tempos.length)
                            : 0;
                        
                        const consistency = avgTime > 0 ? Math.max(0, 100 - (stdDev / avgTime) * 100) : 0;
                        
                        // üÜï Desgaste por volta estimado (se dispon√≠vel)
                        const desgastes = voltasDoStint
                            .map(v => v.desgaste_pneu)
                            .filter(d => d !== undefined && d !== null);
                        
                        let wearRate = 0;
                        if (desgastes.length >= 2) {
                            wearRate = (desgastes[desgastes.length - 1] - desgastes[0]) / desgastes.length;
                        }
                        
                        return {
                            ...stint,
                            tempos: tempos,
                            avgTime: avgTime,
                            bestTime: bestTime,
                            worstTime: worstTime,
                            deltaPerLap: deltaPerLap,
                            rSquared: rSquared,
                            stdDev: stdDev,
                            consistency: consistency,
                            wearRate: wearRate,
                            totalVoltas: stint.total_voltas || tempos.length
                        };
                    });
                    
                    return { 
                        ...piloto, 
                        stints: stintsComTempos,
                        posicao: piloto.posicao || piloto.position || 99
                    };
                }).sort((a, b) => (a.posicao || 99) - (b.posicao || 99));
            };

            // üÜï FUN√á√ÉO: Remove outliers usando IQR (Interquartile Range)
            const removeOutliers = (data) => {
                if (data.length < 4) return data;
                
                const sorted = [...data].sort((a, b) => a - b);
                const q1 = sorted[Math.floor(sorted.length * 0.25)];
                const q3 = sorted[Math.floor(sorted.length * 0.75)];
                const iqr = q3 - q1;
                
                const lowerBound = q1 - 1.5 * iqr;
                const upperBound = q3 + 1.5 * iqr;
                
                return data.filter(x => x >= lowerBound && x <= upperBound);
            };

            // üÜï FUN√á√ÉO: Regress√£o Linear com R¬≤
            const linearRegression = (y) => {
                const n = y.length;
                const x = Array.from({ length: n }, (_, i) => i);
                
                const xMean = x.reduce((a, b) => a + b, 0) / n;
                const yMean = y.reduce((a, b) => a + b, 0) / n;
                
                let numerator = 0;
                let denominator = 0;
                
                for (let i = 0; i < n; i++) {
                    numerator += (x[i] - xMean) * (y[i] - yMean);
                    denominator += (x[i] - xMean) ** 2;
                }
                
                const slope = denominator !== 0 ? numerator / denominator : 0;
                const intercept = yMean - slope * xMean;
                
                // Calcula R¬≤ (coeficiente de determina√ß√£o)
                let ssRes = 0;
                let ssTot = 0;
                
                for (let i = 0; i < n; i++) {
                    const predicted = intercept + slope * x[i];
                    ssRes += (y[i] - predicted) ** 2;
                    ssTot += (y[i] - yMean) ** 2;
                }
                
                const rSquared = ssTot !== 0 ? 1 - (ssRes / ssTot) : 0;
                
                return { slope, intercept, rSquared };
            };

            const formatTime = (seconds) => {
                if (!seconds || seconds <= 0) return '--:--.---';
                const mins = Math.floor(seconds / 60);
                const secs = (seconds % 60).toFixed(3);
                return `${mins}:${secs.padStart(6, '0')}`;
            };

            const getTyreColor = (compound) => {
                if (!compound) return { bg: '#9E9E9E', light: '#BDBDBD' };
                
                const c = compound.toUpperCase().trim()
                    .normalize('NFD').replace(/[\u0300-\u036f]/g, '');

                if (c.includes('SUPER')) return { bg: '#FF00FF', light: '#FF66FF' };
                if (c.includes('SOFT') || c.includes('MACIO')) return { bg: '#E10600', light: '#FF4444' };
                if (c.includes('MEDIUM') || c.includes('MEDIO')) return { bg: '#FFC906', light: '#FFE066' };
                if (c.includes('HARD') || c.includes('DURO')) return { bg: '#EBEBEB', light: '#FFFFFF', border: '#666666' };
                if (c.includes('INTER')) return { bg: '#43B02A', light: '#7ED957' };
                if (c.includes('WET') || c.includes('MOLHADO') || c.includes('CHUVA')) return { bg: '#0072C6', light: '#4AA8FF' };
                
                return { bg: '#9E9E9E', light: '#BDBDBD' };
            };

            const getTyreClass = (compound) => {
                if (!compound) return 'tyre-medium';
                
                const c = compound.toUpperCase().trim()
                    .normalize('NFD').replace(/[\u0300-\u036f]/g, '');
                    
                if (c.includes('SUPER')) return 'tyre-supersoft';
                if (c.includes('SOFT') || c.includes('MACIO')) return 'tyre-soft';
                if (c.includes('MEDIUM') || c.includes('MEDIO')) return 'tyre-medium';
                if (c.includes('HARD') || c.includes('DURO')) return 'tyre-hard';
                if (c.includes('INTER')) return 'tyre-inter';
                if (c.includes('WET') || c.includes('MOLHADO') || c.includes('CHUVA')) return 'tyre-wet';
                
                return 'tyre-medium';
            };

            // Toggle sele√ß√£o de piloto para compara√ß√£o
            const toggleDriverSelection = (driverName) => {
                setSelectedDrivers(prev => {
                    if (prev.includes(driverName)) {
                        return prev.filter(n => n !== driverName);
                    } else {
                        return [...prev, driverName];
                    }
                });
            };

            // Toggle piloto para modo compara√ß√£o (m√°ximo 2)
            const toggleCompareDriver = (driverName) => {
                setCompareDrivers(prev => {
                    if (prev.includes(driverName)) {
                        return prev.filter(n => n !== driverName);
                    } else if (prev.length < 2) {
                        return [...prev, driverName];
                    } else {
                        return [prev[1], driverName]; // Substitui o primeiro
                    }
                });
            };

            // Calcula estat√≠sticas de compara√ß√£o
            const getComparisonStats = () => {
                if (compareDrivers.length !== 2) return null;
                
                const driver1 = data.pilotos.find(p => p.nome === compareDrivers[0]);
                const driver2 = data.pilotos.find(p => p.nome === compareDrivers[1]);
                
                if (!driver1 || !driver2) return null;
                
                const avgTime1 = driver1.stints.reduce((sum, s) => sum + (s.avgTime || 0), 0) / (driver1.stints.length || 1);
                const avgTime2 = driver2.stints.reduce((sum, s) => sum + (s.avgTime || 0), 0) / (driver2.stints.length || 1);
                
                const avgDelta1 = driver1.stints.reduce((sum, s) => sum + (s.deltaPerLap || 0), 0) / (driver1.stints.length || 1);
                const avgDelta2 = driver2.stints.reduce((sum, s) => sum + (s.deltaPerLap || 0), 0) / (driver2.stints.length || 1);
                
                const consistency1 = driver1.stints.reduce((sum, s) => sum + (s.consistency || 0), 0) / (driver1.stints.length || 1);
                const consistency2 = driver2.stints.reduce((sum, s) => sum + (s.consistency || 0), 0) / (driver2.stints.length || 1);
                
                return {
                    timeDiff: avgTime1 - avgTime2,
                    fasterDriver: avgTime1 < avgTime2 ? driver1.nome : driver2.nome,
                    deltaDiff: avgDelta1 - avgDelta2,
                    betterDegradation: avgDelta1 < avgDelta2 ? driver1.nome : driver2.nome,
                    consistencyDiff: consistency1 - consistency2,
                    moreConsistent: consistency1 > consistency2 ? driver1.nome : driver2.nome
                };
            };

            const MiniChart = ({ stint }) => {
                const canvasRef = useRef(null);
                const tyreColor = getTyreColor(stint.tipo_pneu);
                
                useEffect(() => {
                    if (!canvasRef.current || !stint.tempos || stint.tempos.length === 0) return;
                    
                    const canvas = canvasRef.current;
                    const ctx = canvas.getContext('2d');
                    
                    const dpr = window.devicePixelRatio || 1;
                    const rect = canvas.getBoundingClientRect();
                    canvas.width = rect.width * dpr;
                    canvas.height = rect.height * dpr;
                    ctx.scale(dpr, dpr);
                    
                    const width = rect.width;
                    const height = rect.height;
                    
                    ctx.clearRect(0, 0, width, height);
                    
                    const tempos = stint.tempos;
                    if (tempos.length === 0) return;
                    
                    const minTime = Math.min(...tempos) - 0.5;
                    const maxTime = Math.max(...tempos) + 0.5;
                    const timeRange = maxTime - minTime || 1;
                    
                    const padding = { top: 5, right: 10, bottom: 25, left: 5 };
                    const chartWidth = width - padding.left - padding.right;
                    const chartHeight = height - padding.top - padding.bottom;
                    
                    // √Årea de confian√ßa
                    const avgTime = stint.avgTime;
                    const stdDev = stint.stdDev || 0.5;
                    
                    const yTop = padding.top + ((maxTime - (avgTime + stdDev * 1.5)) / timeRange) * chartHeight;
                    const yBottom = padding.top + ((maxTime - (avgTime - stdDev * 1.5)) / timeRange) * chartHeight;
                    
                    ctx.fillStyle = tyreColor.bg + '20';
                    ctx.beginPath();
                    ctx.moveTo(padding.left, yTop);
                    ctx.lineTo(padding.left + chartWidth, yTop);
                    ctx.lineTo(padding.left + chartWidth, yBottom);
                    ctx.lineTo(padding.left, yBottom);
                    ctx.closePath();
                    ctx.fill();
                    
                    // Linha de regress√£o
                    if (tempos.length >= 2) {
                        const startY = stint.avgTime - stint.deltaPerLap * (tempos.length / 2);
                        const endY = stint.avgTime + stint.deltaPerLap * (tempos.length / 2);
                        
                        const y1 = padding.top + ((maxTime - startY) / timeRange) * chartHeight;
                        const y2 = padding.top + ((maxTime - endY) / timeRange) * chartHeight;
                        
                        ctx.beginPath();
                        ctx.moveTo(padding.left, y1);
                        ctx.lineTo(padding.left + chartWidth, y2);
                        ctx.strokeStyle = tyreColor.bg;
                        ctx.lineWidth = 2.5;
                        ctx.stroke();
                    }
                    
                    // Pontos
                    tempos.forEach((tempo, i) => {
                        const x = padding.left + (i / Math.max(tempos.length - 1, 1)) * chartWidth;
                        const y = padding.top + ((maxTime - tempo) / timeRange) * chartHeight;
                        
                        // Sombra
                        ctx.beginPath();
                        ctx.arc(x, y + 1, 5, 0, Math.PI * 2);
                        ctx.fillStyle = 'rgba(0,0,0,0.15)';
                        ctx.fill();
                        
                        // Ponto
                        ctx.beginPath();
                        ctx.arc(x, y, 5, 0, Math.PI * 2);
                        ctx.fillStyle = tyreColor.bg;
                        ctx.fill();
                        ctx.strokeStyle = '#fff';
                        ctx.lineWidth = 1.5;
                        ctx.stroke();
                    });
                    
                    // Labels
                    ctx.fillStyle = '#666';
                    ctx.font = '10px Titillium Web';
                    ctx.textAlign = 'center';
                    ctx.fillText('1', padding.left, height - 8);
                    ctx.fillText(tempos.length.toString(), padding.left + chartWidth, height - 8);
                    
                }, [stint, tyreColor.bg]);
                
                if (!stint.tempos || stint.tempos.length === 0) {
                    return <div className="empty-cell">‚Äî</div>;
                }
                
                const deltaClass = stint.deltaPerLap > 0.02 ? 'positive' : stint.deltaPerLap < -0.02 ? 'negative' : 'neutral';
                
                return (
                    <div className="chart-cell">
                        <div className="stats">
                            <div className="avg">Avg: {formatTime(stint.avgTime)}</div>
                            <div className={`delta ${deltaClass}`}>
                                Œî/lap: {stint.deltaPerLap >= 0 ? '+' : ''}{stint.deltaPerLap.toFixed(3)}s
                            </div>
                            <div className="extra">
                                Best: {formatTime(stint.bestTime)} | R¬≤: {(stint.rSquared * 100).toFixed(0)}%
                            </div>
                            <div className="extra">
                                Laps: {stint.tempos?.length} | Cons: {stint.consistency.toFixed(0)}%
                            </div>
                        </div>
                        <canvas ref={canvasRef} style={{ width: '100%', height: '100px' }} />
                    </div>
                );
            };

            // Componente de Compara√ß√£o
            const ComparisonView = () => {
                const stats = getComparisonStats();
                const driver1Data = data.pilotos.find(p => p.nome === compareDrivers[0]);
                const driver2Data = data.pilotos.find(p => p.nome === compareDrivers[1]);
                
                if (compareDrivers.length !== 2 || !driver1Data || !driver2Data) {
                    return (
                        <div className="comparison-panel">
                            <h3>üèÅ Modo Compara√ß√£o</h3>
                            <p style={{ color: '#aaa', marginBottom: '15px' }}>
                                Selecione 2 pilotos para comparar
                            </p>
                            <div className="driver-selector">
                                {data.pilotos.map(driver => (
                                    <div 
                                        key={driver.nome}
                                        className={`driver-chip ${compareDrivers.includes(driver.nome) ? 'selected' : 'unselected'}`}
                                        onClick={() => toggleCompareDriver(driver.nome)}
                                    >
                                        <span className="position">P{driver.posicao}</span>
                                        {driver.nome}
                                    </div>
                                ))}
                            </div>
                        </div>
                    );
                }
                
                return (
                    <div>
                        <div className="comparison-panel">
                            <h3>üèÅ Compara√ß√£o: {driver1Data.nome} vs {driver2Data.nome}</h3>
                            
                            <div className="driver-selector">
                                {data.pilotos.map(driver => (
                                    <div 
                                        key={driver.nome}
                                        className={`driver-chip ${compareDrivers.includes(driver.nome) ? 'selected' : 'unselected'}`}
                                        onClick={() => toggleCompareDriver(driver.nome)}
                                    >
                                        <span className="position">P{driver.posicao}</span>
                                        {driver.nome}
                                    </div>
                                ))}
                            </div>
                            
                            {stats && (
                                <div className="comparison-stats">
                                    <div className="stat-card">
                                        <div className="label">Mais R√°pido</div>
                                        <div className={`value ${stats.timeDiff > 0 ? 'green' : 'red'}`}>
                                            {Math.abs(stats.timeDiff).toFixed(3)}s
                                        </div>
                                        <div className="driver">{stats.fasterDriver}</div>
                                    </div>
                                    <div className="stat-card">
                                        <div className="label">Melhor Degrada√ß√£o</div>
                                        <div className={`value ${stats.deltaDiff > 0 ? 'green' : 'red'}`}>
                                            {Math.abs(stats.deltaDiff * 1000).toFixed(1)}ms/lap
                                        </div>
                                        <div className="driver">{stats.betterDegradation}</div>
                                    </div>
                                    <div className="stat-card">
                                        <div className="label">Mais Consistente</div>
                                        <div className={`value yellow`}>
                                            {Math.abs(stats.consistencyDiff).toFixed(1)}%
                                        </div>
                                        <div className="driver">{stats.moreConsistent}</div>
                                    </div>
                                </div>
                            )}
                        </div>
                        
                        <div className="comparison-grid" style={{ position: 'relative' }}>
                            <div className="vs-badge">VS</div>
                            
                            {[driver1Data, driver2Data].map((driver, idx) => (
                                <div key={driver.nome} className="comparison-card">
                                    <div className="card-header">
                                        <div 
                                            className={getTyreClass(driver.stints?.[0]?.tipo_pneu)}
                                            style={{ width: '28px', height: '28px', borderRadius: '50%' }}
                                        ></div>
                                        <div className="driver-name">{driver.nome}</div>
                                        <div className="position">P{driver.posicao}</div>
                                    </div>
                                    <div className="card-body">
                                        {driver.stints.map((stint, stintIdx) => (
                                            <div key={stintIdx} className="stint-row">
                                                <div className="stint-number">Stint {stintIdx + 1}</div>
                                                <div className="stint-info">
                                                    <div 
                                                        className="tyre-badge"
                                                        style={{ 
                                                            background: getTyreColor(stint.tipo_pneu).bg,
                                                            color: stint.tipo_pneu?.toLowerCase().includes('hard') ? '#333' : 'white'
                                                        }}
                                                    >
                                                        <div 
                                                            className={getTyreClass(stint.tipo_pneu)}
                                                            style={{ width: '12px', height: '12px', borderRadius: '50%' }}
                                                        ></div>
                                                        {stint.tipo_pneu}
                                                    </div>
                                                    <div className="stint-stats">
                                                        <span>Avg: <strong>{formatTime(stint.avgTime)}</strong></span>
                                                        <span>Œî: <strong style={{ color: stint.deltaPerLap > 0 ? '#e10600' : '#00d27f' }}>
                                                            {stint.deltaPerLap >= 0 ? '+' : ''}{stint.deltaPerLap.toFixed(3)}s
                                                        </strong></span>
                                                        <span>Laps: <strong>{stint.tempos?.length || 0}</strong></span>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            };

            if (isLoading) {
                return (
                    <div className="loading">
                        <div className="loading-content">
                            <div className="loading-spinner">üèéÔ∏è</div>
                            <h2 style={{ fontSize: '2rem', fontWeight: 'bold', marginTop: '20px' }}>Carregando dados...</h2>
                        </div>
                    </div>
                );
            }

            // Ordena pilotos por posi√ß√£o
            const sortedPilotos = [...data.pilotos].sort((a, b) => (a.posicao || 99) - (b.posicao || 99));
            const filteredDrivers = sortedPilotos.filter(p => selectedDrivers.includes(p.nome));

            if (data.pilotos.length === 0) {
                return (
                    <div className="main-container">
                        <div className="no-data">
                            <div style={{ fontSize: '4rem', marginBottom: '20px' }}>üìä</div>
                            <h2>Sem dados de stints dispon√≠veis</h2>
                            <p>Verifique se a tabela pneu_stints est√° sendo preenchida durante a sess√£o.</p>
                            <a href="/" className="btn-primary" style={{ textDecoration: 'none', padding: '12px 30px', borderRadius: '6px' }}>
                                ‚Üê Voltar ao Hist√≥rico
                            </a>
                        </div>
                    </div>
                );
            }

            return (
                <div className="main-container">
                    <div className="header">
                        <h1>{data.sessao?.nome_pista || '2024 GP'}</h1>
                        <span className="flag">üèÅ</span>
                        <span className="subtitle">
                            {viewMode === 'compare' ? 'Driver Comparison' : `Tire degradation trend for ${filteredDrivers.length} drivers`}
                        </span>
                    </div>

                    <div className="controls">
                        <button 
                            className={viewMode === 'grid' ? 'btn-primary' : 'btn-outline'}
                            onClick={() => setViewMode('grid')}
                        >
                            üìä Grid
                        </button>
                        <button 
                            className={viewMode === 'compare' ? 'btn-compare' : 'btn-outline'}
                            onClick={() => setViewMode('compare')}
                        >
                            ‚öîÔ∏è Comparar
                        </button>
                        
                        {viewMode === 'grid' && (
                            <>
                                <div style={{ width: '1px', height: '30px', background: '#ddd', margin: '0 10px' }}></div>
                                
                                <select 
                                    value={selectedDrivers.length}
                                    onChange={(e) => {
                                        const count = parseInt(e.target.value);
                                        setSelectedDrivers(sortedPilotos.slice(0, count).map(p => p.nome));
                                    }}
                                >
                                    <option value={4}>Top 4</option>
                                    <option value={6}>Top 6</option>
                                    <option value={8}>Top 8</option>
                                    <option value={10}>Top 10</option>
                                    <option value={data.pilotos.length}>Todos ({data.pilotos.length})</option>
                                </select>
                                
                                <button className="btn-secondary" onClick={() => setSelectedDrivers(sortedPilotos.slice(0, 4).map(p => p.nome))}>
                                    Top 4
                                </button>
                                <button className="btn-outline" onClick={() => setSelectedDrivers(sortedPilotos.map(p => p.nome))}>
                                    Todos
                                </button>
                            </>
                        )}
                        
                        <div style={{ flex: 1 }}></div>
                        
                        <a href="/" className="btn-secondary" style={{ textDecoration: 'none' }}>‚Üê Hist√≥rico</a>
                    </div>

                    {/* Seletor de pilotos no modo Grid */}
                    {viewMode === 'grid' && (
                        <div className="comparison-panel" style={{ marginBottom: '20px' }}>
                            <h3>üë• Selecionar Pilotos</h3>
                            <div className="driver-selector">
                                {sortedPilotos.map(driver => (
                                    <div 
                                        key={driver.nome}
                                        className={`driver-chip ${selectedDrivers.includes(driver.nome) ? 'selected' : 'unselected'}`}
                                        onClick={() => toggleDriverSelection(driver.nome)}
                                    >
                                        <span className="position">P{driver.posicao}</span>
                                        {driver.nome}
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {viewMode === 'compare' ? (
                        <ComparisonView />
                    ) : (
                        <>
                            {filteredDrivers.length > 0 && (
                                <>
                                    <div 
                                        className="grid-container"
                                        style={{ 
                                            gridTemplateColumns: `100px repeat(${filteredDrivers.length}, 1fr)`,
                                            gridTemplateRows: `auto repeat(${maxStints}, 1fr)`
                                        }}
                                    >
                                        <div className="corner-cell"></div>
                                        {filteredDrivers.map((driver) => (
                                            <div key={driver.nome} className="driver-header">
                                                <div 
                                                    className={getTyreClass(driver.stints?.[0]?.tipo_pneu)} 
                                                    style={{ width: '24px', height: '24px', borderRadius: '50%', boxShadow: '0 2px 4px rgba(0,0,0,0.3)' }}
                                                ></div>
                                                <div className="driver-name">{driver.nome}</div>
                                                <div className="driver-position">P{driver.posicao}</div>
                                            </div>
                                        ))}
                                        
                                        {Array.from({ length: maxStints }, (_, stintIdx) => (
                                            <React.Fragment key={stintIdx}>
                                                <div className="stint-label">Stint {stintIdx + 1}</div>
                                                
                                                {filteredDrivers.map((driver) => {
                                                    const stint = driver.stints?.[stintIdx];
                                                    
                                                    if (!stint) {
                                                        return <div key={driver.nome} className="empty-cell">‚Äî</div>;
                                                    }
                                                    
                                                    return <MiniChart key={`${driver.nome}-${stintIdx}`} stint={stint} />;
                                                })}
                                            </React.Fragment>
                                        ))}
                                    </div>

                                    <div className="x-axis-label">Stint Lap</div>
                                </>
                            )}
                        </>
                    )}

                    <div className="legend">
                        <div className="legend-section">
                            <div className="legend-item">
                                <div className="legend-line solid"></div>
                                <span>Regression trend (R¬≤ = precis√£o)</span>
                            </div>
                        </div>
                        
                        <div className="legend-section">
                            <div className="legend-item"><div className="tyre-dot tyre-supersoft"></div><span>Supersoft</span></div>
                            <div className="legend-item"><div className="tyre-dot tyre-soft"></div><span>Soft</span></div>
                            <div className="legend-item"><div className="tyre-dot tyre-medium"></div><span>Medium</span></div>
                            <div className="legend-item"><div className="tyre-dot tyre-hard"></div><span>Hard</span></div>
                            <div className="legend-item"><div className="tyre-dot tyre-inter"></div><span>Inter</span></div>
                            <div className="legend-item"><div className="tyre-dot tyre-wet"></div><span>Wet</span></div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<TyreDegradationChart />);
    </script>
    {% endraw %}
</body>
</html>