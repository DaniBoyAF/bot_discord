<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GP Dashboard - Race Pace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #root { min-height: 100vh; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 2s linear infinite; }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root">
        <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(to bottom right, #1f2937, #991b1b, #1f2937); color: white;">
            <div style="text-align: center;">
                <div style="font-size: 4rem; margin-bottom: 1rem;" class="animate-spin">üèéÔ∏è</div>
                <h2 style="font-size: 2rem; font-weight: bold;">Carregando Dashboard...</h2>
            </div>
        </div>
    </div>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7/babel.min.js"></script>

    {% raw %}
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        const Trophy = (props) => (
            <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/>
                <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/>
                <path d="M4 22h16"/>
                <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/>
                <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/>
                <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/>
            </svg>
        );

        const Zap = (props) => (
            <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
            </svg>
        );

        const Flag = (props) => (
            <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/>
                <line x1="4" y1="22" x2="4" y2="15"/>
            </svg>
        );

        const Clock = (props) => (
            <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <polyline points="12 6 12 12 16 14"/>
            </svg>
        );
        
        const GPDashboard = () => {
            const [raceData, setRaceData] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [calcMode, setCalcMode] = useState('trimmed');  // üÜï Modo de c√°lculo
            const [trimPercent, setTrimPercent] = useState(10);   // üÜï % de outliers removidos
            const [totalVoltasSessao, setTotalVoltasSessao] = useState(0);
            const [minPorcentagem, setMinPorcentagem] = useState(0);

            useEffect(() => {
                const fetchDados = async () => {
                    try {
                        const urlParams = new URLSearchParams(window.location.search);
                        const sessaoId = urlParams.get('sessao');
                        
                        let url = '/dados_voltas';
                        if (sessaoId) {
                            url = `/dados_voltas/${sessaoId}`;
                        }
                        
                        console.log("Fetching:", url);
                        const response = await fetch(url, { cache: 'no-store' });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}`);
                        }
                        
                        const dados = await response.json();
                        console.log("Dados recebidos:", dados);
                        
                        // Suporta formato novo e antigo
                        if (dados.pilotos) {
                            setTotalVoltasSessao(dados.total_voltas_sessao || 0);
                            setRaceData(dados.pilotos);
                        } else if (Array.isArray(dados)) {
                            const maxVoltas = Math.max(...dados.map(d => d.voltas?.length || 0), 0);
                            setTotalVoltasSessao(maxVoltas);
                            setRaceData(dados);
                        } else {
                            setRaceData([]);
                        }
                    } catch (error) {
                        console.error("Erro ao buscar dados:", error);
                        setRaceData([]);
                    } finally {
                        setIsLoading(false);
                    }
                };

                fetchDados();
                
                const urlParams = new URLSearchParams(window.location.search);
                const sessaoId = urlParams.get('sessao');
                
                let interval;
                if (!sessaoId) {
                    interval = setInterval(fetchDados, 2000);
                }
                
                return () => {
                    if (interval) clearInterval(interval);
                };
            }, []);

            // üÜï Fun√ß√µes de c√°lculo de m√©dia
            const calcularMedia = {
                // M√©dia simples de todas as voltas
                simple: (lapTimes) => {
                    if (lapTimes.length === 0) return 0;
                    return lapTimes.reduce((a, b) => a + b, 0) / lapTimes.length;
                },
                
                // M√©dia removendo X% piores voltas (pit stops, erros)
                trimmed: (lapTimes, trimPercent = 10) => {
                    if (lapTimes.length === 0) return 0;
                    const sorted = [...lapTimes].sort((a, b) => a - b);
                    const cutoff = Math.max(1, Math.floor(sorted.length * (1 - trimPercent / 100)));
                    const trimmed = sorted.slice(0, cutoff);
                    return trimmed.reduce((a, b) => a + b, 0) / trimmed.length;
                },
                
                // Mediana (menos afetada por outliers)
                median: (lapTimes) => {
                    if (lapTimes.length === 0) return 0;
                    const sorted = [...lapTimes].sort((a, b) => a - b);
                    const mid = Math.floor(sorted.length / 2);
                    return sorted.length % 2 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
                },
                
                // Top 5 melhores voltas
                top5: (lapTimes) => {
                    if (lapTimes.length === 0) return 0;
                    const sorted = [...lapTimes].sort((a, b) => a - b);
                    const top = sorted.slice(0, Math.min(5, sorted.length));
                    return top.reduce((a, b) => a + b, 0) / top.length;
                },
                
                // Top 10 melhores voltas
                top10: (lapTimes) => {
                    if (lapTimes.length === 0) return 0;
                    const sorted = [...lapTimes].sort((a, b) => a - b);
                    const top = sorted.slice(0, Math.min(10, sorted.length));
                    return top.reduce((a, b) => a + b, 0) / top.length;
                },
                
                // Interquartil (remove 25% piores e 25% melhores)
                iqr: (lapTimes) => {
                    if (lapTimes.length < 4) return calcularMedia.simple(lapTimes);
                    const sorted = [...lapTimes].sort((a, b) => a - b);
                    const q1 = Math.floor(sorted.length * 0.25);
                    const q3 = Math.floor(sorted.length * 0.75);
                    const middle = sorted.slice(q1, q3);
                    return middle.reduce((a, b) => a + b, 0) / middle.length;
                }
            };

            const processRacerData = (racer) => {
                if (!racer || !racer.voltas) return null;

                // Filtra voltas inv√°lidas
                const validLaps = racer.voltas.filter(lap => {
                    if (!lap.tempo_total || lap.tempo_total <= 0) return false;
                    
                    // Remove voltas muito lentas (pit stops, safety car)
                    // e muito r√°pidas (erros de telemetria)
                    return lap.tempo_total > 30 && lap.tempo_total < 300;
                });

                if (validLaps.length < 2) return null;

                const lapTimes = validLaps.map(lap => lap.tempo_total);
                const bestLap = Math.min(...lapTimes);
                const worstLap = Math.max(...lapTimes);
                const totalVoltasPiloto = racer.total_voltas_piloto || racer.voltas.length;

                // üÜï Calcula m√©dia baseado no modo selecionado
                let racePace;
                switch (calcMode) {
                    case 'simple':
                        racePace = calcularMedia.simple(lapTimes);
                        break;
                    case 'trimmed':
                        racePace = calcularMedia.trimmed(lapTimes, trimPercent);
                        break;
                    case 'median':
                        racePace = calcularMedia.median(lapTimes);
                        break;
                    case 'top5':
                        racePace = calcularMedia.top5(lapTimes);
                        break;
                    case 'top10':
                        racePace = calcularMedia.top10(lapTimes);
                        break;
                    case 'iqr':
                        racePace = calcularMedia.iqr(lapTimes);
                        break;
                    default:
                        racePace = calcularMedia.trimmed(lapTimes, trimPercent);
                }

                // Calcula consist√™ncia (desvio padr√£o)
                const mean = calcularMedia.simple(lapTimes);
                const variance = lapTimes.reduce((sum, t) => sum + Math.pow(t - mean, 2), 0) / lapTimes.length;
                const stdDev = Math.sqrt(variance);
                const consistency = 100 - Math.min(100, (stdDev / mean) * 100 * 10); // 0-100%

                return {
                    nome: racer.nome,
                    numero: racer.numero,
                    position: racer.posicao || racer.position,
                    tyres: racer.pneu_atual || racer.tyres || '?',
                    bestLap: bestLap,
                    worstLap: worstLap,
                    racePace: racePace,
                    simpleAvg: calcularMedia.simple(lapTimes),
                    lapCount: validLaps.length,
                    totalVoltasPiloto: totalVoltasPiloto,
                    consistency: consistency,
                    color: `hsl(${(racer.numero || 0) * 37 % 360}, 70%, 50%)`
                };
            };

            // Filtra por % de conclus√£o
            const minVoltasParaCompletar = totalVoltasSessao > 0 
                ? Math.floor(totalVoltasSessao * (minPorcentagem / 100))
                : 0;

            const racers = raceData
                .map(processRacerData)
                .filter(r => {
                    if (r === null) return false;
                    if (minPorcentagem > 0 && totalVoltasSessao > 0) {
                        return r.totalVoltasPiloto >= minVoltasParaCompletar;
                    }
                    return true;
                });

            const sortedRacers = [...racers].sort((a, b) => a.racePace - b.racePace);

            const formatTime = (seconds) => {
                if (!seconds || seconds <= 0) return '--:--.---';
                const mins = Math.floor(seconds / 60);
                const secs = (seconds % 60).toFixed(3);
                return `${mins}:${secs.padStart(6, '0')}`;
            };

            // Nomes amig√°veis dos modos
            const modeNames = {
                simple: 'üìä M√©dia Simples',
                trimmed: `üéØ Sem ${trimPercent}% Piores`,
                median: 'üìà Mediana',
                top5: 'üèÜ Top 5 Voltas',
                top10: 'ü•á Top 10 Voltas',
                iqr: 'üìâ Interquartil (25-75%)'
            };

            if (isLoading) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-gray-900 via-red-900 to-gray-900 flex items-center justify-center">
                        <div className="text-center text-white">
                            <div className="text-6xl mb-4 animate-bounce">üèéÔ∏è</div>
                            <h2 className="text-3xl font-bold">Carregando dados...</h2>
                        </div>
                    </div>
                );
            }

            if (sortedRacers.length === 0) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-gray-900 via-red-900 to-gray-900 flex items-center justify-center">
                        <div className="text-center text-white">
                            <Flag className="mx-auto mb-4" size={64} />
                            <h2 className="text-3xl font-bold mb-4">Aguardando dados da corrida</h2>
                            <p className="text-xl text-gray-400 mb-4">
                                {raceData.length > 0 
                                    ? `Nenhum piloto com ${minPorcentagem}% das voltas` 
                                    : "Verifique se os dados est√£o dispon√≠veis"}
                            </p>
                            {raceData.length > 0 && (
                                <button 
                                    onClick={() => setMinPorcentagem(0)}
                                    className="bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-6 rounded-lg mb-4"
                                >
                                    Mostrar Todos Pilotos
                                </button>
                            )}
                            <br/>
                            <a href="/selecionar_sessao" className="mt-6 inline-block bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg">
                                üìä Ver Hist√≥rico de Sess√µes
                            </a>
                        </div>
                    </div>
                );
            }

            const maxPace = Math.max(...sortedRacers.map(r => r.racePace));

            return (
                <div className="min-h-screen bg-gradient-to-br from-gray-900 via-red-900 to-gray-900 p-4 md:p-8 relative overflow-hidden">
                    <div className="absolute inset-0 opacity-10">
                        <div className="absolute inset-0" style={{
                            backgroundImage: 'repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,.05) 10px, rgba(255,255,255,.05) 20px)'
                        }}/>
                    </div>

                    <div className="relative z-10 max-w-7xl mx-auto">
                        {/* Header */}
                        <div className="text-center mb-6 md:mb-8">
                            <h1 className="text-3xl md:text-5xl font-bold text-white mb-2 flex items-center justify-center gap-2 flex-wrap">
                                <Flag className="text-red-500" size={40} />
                                <span>Race Pace Analysis</span>
                                <Flag className="text-green-500" size={40} />
                            </h1>
                            <p className="text-base md:text-xl text-gray-300">{modeNames[calcMode]}</p>
                        </div>

                        {/* üÜï Controles de c√°lculo */}
                        <div className="bg-gray-800 bg-opacity-90 rounded-lg p-4 mb-6 flex flex-wrap gap-3 items-center justify-center">
                            <span className="text-white font-semibold">Modo:</span>
                            <select
                                value={calcMode}
                                onChange={(e) => setCalcMode(e.target.value)}
                                className="px-3 py-2 rounded-lg bg-gray-700 text-white border border-gray-600 font-semibold"
                            >
                                <option value="simple">üìä M√©dia Simples</option>
                                <option value="trimmed">üéØ Remover Piores</option>
                                <option value="median">üìà Mediana</option>
                                <option value="top5">üèÜ Top 5 Voltas</option>
                                <option value="top10">ü•á Top 10 Voltas</option>
                                <option value="iqr">üìâ Interquartil</option>
                            </select>

                            {calcMode === 'trimmed' && (
                                <>
                                    <span className="text-white">Remover:</span>
                                    <select
                                        value={trimPercent}
                                        onChange={(e) => setTrimPercent(Number(e.target.value))}
                                        className="px-3 py-2 rounded-lg bg-gray-700 text-white border border-gray-600"
                                    >
                                        <option value={5}>5% piores</option>
                                        <option value={10}>10% piores</option>
                                        <option value={15}>15% piores</option>
                                        <option value={20}>20% piores</option>
                                        <option value={25}>25% piores</option>
                                    </select>
                                </>
                            )}

                            <span className="text-white ml-4">Filtro:</span>
                            <select
                                value={minPorcentagem}
                                onChange={(e) => setMinPorcentagem(Number(e.target.value))}
                                className="px-3 py-2 rounded-lg bg-gray-700 text-white border border-green-500"
                            >
                                <option value={0}>üèéÔ∏è Todos pilotos</option>
                                <option value={50}>üìä M√≠n 50% voltas</option>
                                <option value={75}>üìä M√≠n 75% voltas</option>
                                <option value={90}>üìä M√≠n 90% voltas</option>
                                <option value={100}>üèÅ S√≥ quem completou</option>
                            </select>

                            <a href="/" className="ml-4 bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg">
                                ‚Üê Hist√≥rico
                            </a>
                        </div>

                        {/* P√≥dio */}
                        <div className="grid grid-cols-3 gap-2 md:gap-4 mb-6 md:mb-8 max-w-4xl mx-auto">
                            {[1, 0, 2].map((sortIdx) => {
                                if (!sortedRacers[sortIdx]) return <div key={sortIdx}></div>;
                                const racer = sortedRacers[sortIdx];
                                const actualPosition = sortIdx;
                                const heights = ['h-36 md:h-48', 'h-28 md:h-40', 'h-24 md:h-32'];
                                const colors = [
                                    'from-yellow-600 to-yellow-400',
                                    'from-gray-500 to-gray-400', 
                                    'from-orange-600 to-orange-400'
                                ];
                                
                                return (
                                    <div key={racer.nome} className="text-center">
                                        <div className={`${heights[actualPosition]} bg-gradient-to-t ${colors[actualPosition]} rounded-t-lg flex items-center justify-center flex-col shadow-2xl transform hover:scale-105 transition-transform`}>
                                            <Trophy size={28} className="text-white mb-1" />
                                            <span className="text-xl md:text-3xl font-bold text-white">P{actualPosition + 1}</span>
                                            <span className="text-xs md:text-base font-semibold text-white mt-1 px-1 truncate max-w-full">{racer.nome}</span>
                                            <span className="text-xs md:text-sm text-white">{formatTime(racer.racePace)}</span>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>

                        {/* Tabela de Race Pace */}
                        <div className="bg-gray-800 bg-opacity-90 rounded-lg p-4 md:p-6 shadow-2xl backdrop-blur-sm">
                            <h2 className="text-xl md:text-2xl font-bold text-white mb-4 flex items-center gap-2">
                                <Zap className="text-yellow-400" />
                                Ritmo de Corrida - {sortedRacers.length} Pilotos
                            </h2>
                            
                            <div className="space-y-2">
                                {sortedRacers.map((racer, idx) => {
                                    const leaderPace = sortedRacers[0].racePace;
                                    const diff = racer.racePace - leaderPace;
                                    const barWidth = (racer.racePace / maxPace) * 100;
                                    

                                    return (
                                        <div key={racer.nome} className="group">
                                            <div className="flex items-center gap-2 mb-1 text-xs md:text-sm">
                                                <span className="font-bold text-white w-6">{idx + 1}.</span>
                                                <span className="text-white font-semibold flex-1 truncate">{racer.nome}</span>
                                                <span className="text-gray-400">#{racer.numero}</span>
                                                <span className="px-2 py-0.5 bg-gray-700 rounded text-white text-xs">{racer.tyres}</span>
                                                <span className="text-gray-500 text-xs">{racer.lapCount}v</span>
                                            </div>
                                            
                                            <div className="flex items-center gap-2 ml-8">
                                                <div className="flex-1 bg-gray-700 rounded-full h-5 md:h-6 relative overflow-hidden">
                                                    <div 
                                                        className="h-full rounded-full transition-all duration-500 flex items-center justify-end pr-2 group-hover:brightness-125"
                                                        style={{
                                                            width: `${barWidth}%`,
                                                            background: `linear-gradient(to right, ${racer.color}, ${racer.color}cc)`
                                                        }}
                                                    >
                                                        <span className="text-white font-bold text-xs">{formatTime(racer.racePace)}</span>
                                                    </div>
                                                </div>
                                                <div className="flex gap-2 text-xs min-w-[140px] md:min-w-[200px]">
                                                    <span className={`font-semibold w-14 ${idx === 0 ? 'text-green-400' : 'text-yellow-400'}`}>
                                                        {idx === 0 ? 'LEADER' : `+${diff.toFixed(3)}`}
                                                    </span>
                                                    <div className="flex items-center gap-1 text-purple-400 text-xs" title="Consist√™ncia">
                                                        üìä {racer.consistency.toFixed(0)}%
                                                    </div>
                                                    <div className="flex items-center gap-1 text-green-400 text-xs" title="Melhor volta">
                                                        <Clock size={10} />
                                                        {formatTime(racer.bestLap)}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>

                        {/* Stats */}
                        <div className="mt-6 grid grid-cols-2 md:grid-cols-4 gap-2 md:gap-4 text-center">
                            <div className="bg-gray-800 bg-opacity-90 p-3 rounded-lg">
                                <p className="text-gray-400 text-xs">üèÜ Melhor Race Pace</p>
                                <p className="text-base md:text-xl font-bold text-green-400 truncate">{sortedRacers[0]?.nome}</p>
                                <p className="text-sm text-white">{formatTime(sortedRacers[0]?.racePace)}</p>
                            </div>
                            <div className="bg-gray-800 bg-opacity-90 p-3 rounded-lg">
                                <p className="text-gray-400 text-xs">‚ö° Melhor Volta</p>
                                <p className="text-base md:text-xl font-bold text-yellow-400">
                                    {formatTime(Math.min(...racers.map(r => r.bestLap)))}
                                </p>
                            </div>
                            <div className="bg-gray-800 bg-opacity-90 p-3 rounded-lg">
                                <p className="text-gray-400 text-xs">üìä Mais Consistente</p>
                                <p className="text-base md:text-xl font-bold text-purple-400 truncate">
                                    {[...racers].sort((a, b) => b.consistency - a.consistency)[0]?.nome}
                                </p>
                                <p className="text-sm text-white">
                                    {[...racers].sort((a, b) => b.consistency - a.consistency)[0]?.consistency.toFixed(1)}%
                                </p>
                            </div>
                            <div className="bg-gray-800 bg-opacity-90 p-3 rounded-lg">
                                <p className="text-gray-400 text-xs">üèÅ Voltas da Sess√£o</p>
                                <p className="text-base md:text-xl font-bold text-blue-400">{totalVoltasSessao}</p>
                                <p className="text-sm text-gray-400">{racers.length} pilotos</p>
                            </div>
                        </div>

                        {/* Legenda */}
                        <div className="mt-4 bg-gray-800 bg-opacity-60 rounded-lg p-3 text-center">
                            <p className="text-gray-400 text-xs md:text-sm">
                                <span className="text-green-400">üü¢ Race Pace</span> = {modeNames[calcMode]} | 
                                <span className="text-purple-400 ml-2">üìä Consist√™ncia</span> = Menor varia√ß√£o entre voltas | 
                                <span className="text-yellow-400 ml-2">‚ö° Best</span> = Melhor volta
                            </p>
                        </div>
                    </div>
                </div>
            );
        };

        function renderApp() {
            const rootElement = document.getElementById('root');
            if (rootElement) {
                const root = ReactDOM.createRoot(rootElement);
                root.render(<GPDashboard />);
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', renderApp);
        } else {
            renderApp();
        }
    </script>
    {% endraw %}
</body>
</html>